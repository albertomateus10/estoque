<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Estoque</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background: #f7f7f7; }
    h1 { color: #2c3e50; }
    .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
    .base-upload { display: flex; align-items: center; gap: 8px; font-size: 1.1em; background: #fff; padding: 3px 8px; border-radius: 8px; box-shadow: 0 2px 5px #0001; }
    .base-upload label { font-weight: bold; color: #2980b9; margin-right: 3px; }
    .base-upload input[type="file"] { display: none; }
    .base-upload .file-btn { background: #7ed6b5; color: #23272f; border: none; border-radius: 6px; padding: 3px 7px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
    .base-upload .file-btn:hover { background: #5a8ac6; color: #fff; }
    .base-upload .file-name { font-size: 0.98em; color: #555; margin-left: 5px; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .tabs { position: relative; display: flex; gap: 20px; margin-bottom: 20px; background: #23272f; padding: 24px 0 0 24px; border-radius: 0 0 12px 12px; border-bottom: 4px solid #7ed6b5; box-shadow: 0 2px 8px #0002; }
    .tab-btn { padding: 18px 40px 16px; background: #374151; border: none; border-radius: 12px 12px 0 0; font-weight: bold; cursor: pointer; color: #fff; font-size: 1.3em; transition: background 0.2s, color 0.2s, box-shadow 0.2s; margin-bottom: -4px; box-shadow: 0 2px 8px #0001; outline: none; position: relative; }
    .tab-btn.active { background: #7ed6b5; color: #23272f; box-shadow: 0 6px 18px #0002; z-index: 2; }
    .tab-btn:not(.active):hover { background: #42506a; color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .summary { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
    .summary-box { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 12px 18px; min-width: 170px; }
    .summary-box strong { font-size: 1.3em; color: #2980b9; }
    .summary-box.margem { background: #5a8ac6; color: #fff; }
    .summary-box.margem strong { color: #fff; }
    .summary-box.km { background: #f7b731; color: #23272f; }
    .summary-box.km strong { color: #23272f; }
    /* Opcional: destaque suave para a cor mais frequente */
    .summary-box.cor { background: #ffeaa7; color: #23272f; }
    .summary-box.cor strong { color: #23272f; }

    .filters { margin-bottom: 20px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
    .filters input { margin-right: 10px; padding: 5px 8px; }

    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 8px 6px; text-align: left; }
    th { background: #2980b9; color: #fff; cursor: pointer; user-select: none; }
    tr:nth-child(even) { background: #f2f2f2; }
    tr:hover { background: #eaf6ff; }
    .sort-arrow { font-size: 0.9em; margin-left: 3px; }

    .charts { display: flex; gap: 30px; margin: 30px 0; flex-wrap: wrap; }
    .chart-container { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 20px; flex: 1 1 350px; min-width: 320px; max-width: 480px; }
    canvas { max-width: 420px !important; max-height: 320px !important; }

    @media (max-width: 900px) {
      .charts { flex-direction: column; gap: 20px; }
      .chart-container { max-width: 100%; }
      .header-bar { flex-direction: column; align-items: flex-start; gap: 10px; }
    }

    /* Multi-select */
    .multiselect { position: relative; display: inline-block; min-width: 180px; margin-right: 10px; }
    .multiselect .selectBox { display: flex; align-items: center; background: #fff; border: 1px solid #aaa; border-radius: 6px; padding: 6px 10px; cursor: pointer; min-width: 160px; user-select: none; }
    .multiselect .selectBox:after { content: "‚ñº"; font-size: 0.8em; margin-left: auto; color: #2980b9; }
    .multiselect .checkboxes { display: none; position: absolute; background: #fff; border: 1px solid #aaa; border-radius: 6px; box-shadow: 0 2px 8px #0002; z-index: 10; max-height: 220px; overflow-y: auto; min-width: 180px; margin-top: 2px; }
    .multiselect.active .checkboxes { display: block; }
    .multiselect label { display: block; padding: 4px 10px; cursor: pointer; font-size: 1em; }
    .multiselect label:hover { background: #f2f2f2; }

    .credit { position: absolute; bottom: 6px; right: 20px; color: #ffff; font-size: 0.75em; pointer-events: none; }

    /* Indicadores de status */
    .status-info { border-radius: 4px; padding: 8px 12px; margin: 10px 0; font-size: 0.9em; }
    .status-success { background: #e8f5e8; border: 1px solid #4caf50; color: #2e7d32; }
    .status-error { background: #ffebee; border: 1px solid #f44336; color: #c62828; }

    /* Bot√µes de exporta√ß√£o */
    .export-buttons { display: flex; align-items: center; gap: 8px; }
    .export-btn { background: #20bf6b; color: #fff; border: none; border-radius: 6px; padding: 4px 10px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
    .export-btn:hover { opacity: 0.85; }

    /* >>> NOVO: estilo para linha inteira negativa <<< */
    tr.neg-row td { color: #c62828 !important; background: #ffebee !important; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="header-bar">
    <div class="export-buttons">
      <button class="export-btn" onclick="exportToExcel()">Exportar Excel</button>
    </div>
    <div class="base-upload">
      <label for="basefile">Base:</label>
      <button class="file-btn" onclick="document.getElementById('basefile').click()">Selecionar Excel</button>
      <input type="file" id="basefile" accept=".xlsx,.xls" />
      <span class="file-name" id="basefile-name"></span>
    </div>
  </div>

  <!-- Indicador de status -->
  <div id="status-info" class="status-info" style="display: none;"></div>

  <div class="tabs">
    <button class="tab-btn active" onclick="showTab(0)">Estoque Dispon√≠vel</button>
    <div class="credit">Desenvolvido por Alberto Mateus para o Grupo San Marino.</div>
  </div>

  <!-- Aba 1: Estoque Dispon√≠vel -->
  <div class="tab-content active" id="tab-disponivel">
    <div class="summary">
      <div class="summary-box"><div>Quantidade de ve√≠culos</div><strong id="qtd-disponivel">0</strong></div>
      <div class="summary-box"><div>M√©dia dos Dias de Estoque</div><strong id="media-dias-disponivel">0</strong></div>
      <div class="summary-box km"><div>KM m√©dia</div><strong id="media-km-disponivel">0</strong></div>

      <!-- >>> NOVO KPI: Cor mais frequente (√† direita do KM m√©dia) -->
      <div class="summary-box cor"><div>Cor mais frequente no estoque</div><strong id="cor-frequente-disponivel">-</strong></div>

      <div class="summary-box"><div>M√©dia do Ano</div><strong id="media-ano-disponivel">0</strong></div>
      <div class="summary-box"><div>Valor M√©dio do Estoque (Custo)</div><strong id="media-custo-disponivel">R$ 0,00</strong></div>
      <div class="summary-box"><div>M√©dia do Pre√ßo de Venda</div><strong id="media-preco-venda-disponivel">R$ 0,00</strong></div>
      <div class="summary-box"><div>Pre√ßo de Custo do estoque</div><strong id="total-custo-disponivel">R$ 0,00</strong></div>
      <div class="summary-box"><div>Pre√ßo de Venda do estoque</div><strong id="total-preco-disponivel">R$ 0,00</strong></div>
      <div class="summary-box margem"><div>Margem Bruta Somada</div><strong id="margem-bruta-disponivel">R$ 0,00</strong></div>
      <div class="summary-box margem"><div>% da Margem Bruta</div><strong id="margem-percent-disponivel">0%</strong></div>
      <div class="summary-box margem"><div>Margem M√©dia por Ve√≠culo</div><strong id="margem-media-disponivel">R$ 0,00</strong></div>
    </div>

    <div class="filters">
      <input type="text" id="search-disponivel" placeholder="Buscar modelo, placa, cor..." />
      <div class="multiselect" id="multiselect-proposta-disponivel"></div>
      <div class="multiselect" id="multiselect-patio-disponivel"></div>
      <div class="multiselect" id="multiselect-modelo-disponivel"></div>
      <div class="multiselect" id="multiselect-descricao-disponivel"></div>
      <button onclick="resetFilters('disponivel')">Limpar Filtros</button>
    </div>

    <div class="charts">
      <div class="chart-container">
        <div style="text-align:center; color:#2980b9; font-weight:bold; font-size:1.15em; margin-bottom:6px;">Top 5 Modelos em Estoque</div>
        <canvas id="pie-modelos"></canvas>
      </div>
      <div class="chart-container">
        <div style="text-align:center; color:#2980b9; font-weight:bold; font-size:1.15em; margin-bottom:6px;">Quantidade / Dias em Estoque</div>
        <canvas id="bar-dias"></canvas>
      </div>
      <div class="chart-container">
        <div style="text-align:center; color:#2980b9; font-weight:bold; font-size:1.15em; margin-bottom:6px;">Estoque por Loja</div>
        <canvas id="bar-lojas"></canvas>
      </div>
    </div>

    <table id="tabela-disponivel">
      <thead>
        <tr>
          <th data-col="proposta">Proposta <span class="sort-arrow"></span></th>
          <th data-col="patio">P√°tio <span class="sort-arrow"></span></th>
          <th data-col="modelo">Modelo <span class="sort-arrow"></span></th>
          <th data-col="dias">Dias <span class="sort-arrow"></span></th>
          <th data-col="ano">Ano <span class="sort-arrow"></span></th>
          <th data-col="cor">Cor Externa <span class="sort-arrow"></span></th>
          <th data-col="placa">Placa <span class="sort-arrow"></span></th>
          <th data-col="km">KM <span class="sort-arrow"></span></th>
          <th data-col="preco">Pre√ßo Venda <span class="sort-arrow"></span></th>
          <th data-col="descricao">Descricao Situa√ß√£o <span class="sort-arrow"></span></th>
          <th data-col="custo">Total Nota Fabrica <span class="sort-arrow"></span></th>
          <th data-col="margem">Margem Bruta <span class="sort-arrow"></span></th>
          <th data-col="margemPercent">% Margem <span class="sort-arrow"></span></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Aba 2: Repasses N√£o Vendidos -->
  <div class="tab-content" id="tab-repasse">
    <h1>REPASSSES N√ÉO VENDIDOS</h1>
    <div class="summary">
      <div class="summary-box"><div>Quantidade de carros</div><strong id="qtd-repasse">0</strong></div>
      <div class="summary-box"><div>M√©dia de dias de estoque</div><strong id="media-dias-repasse">0</strong></div>
      <div class="summary-box km"><div>KM m√©dia dos carros</div><strong id="media-km-repasse">0</strong></div>
      <div class="summary-box"><div>Valor total de custo</div><strong id="total-custo-repasse">R$ 0,00</strong></div>
      <div class="summary-box"><div>M√©dia por ve√≠culo</div><strong id="media-veiculo-repasse">R$ 0,00</strong></div>
      <div class="summary-box margem"><div>Margem M√©dia por Ve√≠culo</div><strong id="margem-media-repasse">R$ 0,00</strong></div>
    </div>

    <div class="filters">
      <input type="text" id="search-repasse" placeholder="Buscar modelo, placa, cor..." />
      <div class="multiselect" id="multiselect-proposta-repasse"></div>
      <div class="multiselect" id="multiselect-patio-repasse"></div>
      <div class="multiselect" id="multiselect-descricao-repasse"></div>
      <button onclick="resetFilters('repasse')">Limpar Filtros</button>
    </div>

    <table id="tabela-repasse">
      <thead>
        <tr>
          <th data-col="proposta">Proposta <span class="sort-arrow"></span></th>
          <th data-col="patio">P√°tio <span class="sort-arrow"></span></th>
          <th data-col="modelo">Modelo <span class="sort-arrow"></span></th>
          <th data-col="dias">Dias <span class="sort-arrow"></span></th>
          <th data-col="ano">Ano <span class="sort-arrow"></span></th>
          <th data-col="cor">Cor Externa <span class="sort-arrow"></span></th>
          <th data-col="placa">Placa <span class="sort-arrow"></span></th>
          <th data-col="km">KM <span class="sort-arrow"></span></th>
          <th data-col="preco">Pre√ßo Venda <span class="sort-arrow"></span></th>
          <th data-col="descricao">Descricao Situa√ß√£o <span class="sort-arrow"></span></th>
          <th data-col="custo">Total Nota Fabrica <span class="sort-arrow"></span></th>
          <th data-col="margem">Margem Bruta <span class="sort-arrow"></span></th>
          <th data-col="margemPercent">% Margem <span class="sort-arrow"></span></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Aba 3: Total -->
  <div class="tab-content" id="tab-total">
    <h1>TOTAL</h1>
    <div class="summary">
      <div class="summary-box"><div>Quantidade total de ve√≠culos</div><strong id="qtd-total">0</strong></div>
      <div class="summary-box"><div>M√©dia Dias em Estoque</div><strong id="media-dias-total">0</strong></div>
      <div class="summary-box km"><div>KM m√©dia dos carros</div><strong id="media-km-total">0</strong></div>
      <div class="summary-box"><div>Soma Total Nota F√°brica</div><strong id="total-custo-total">R$ 0,00</strong></div>
      <div class="summary-box"><div>Soma Total Pre√ßo Venda</div><strong id="total-preco-total">R$ 0,00</strong></div>
      <div class="summary-box margem"><div>Margem Bruta Total</div><strong id="margem-bruta-total">R$ 0,00</strong></div>
      <div class="summary-box margem"><div>% da Margem Bruta</div><strong id="margem-percent-total">0%</strong></div>
      <div class="summary-box margem"><div>Margem M√©dia por Ve√≠culo</div><strong id="margem-media-total">R$ 0,00</strong></div>
    </div>

    <div class="filters">
      <input type="text" id="search-total" placeholder="Buscar modelo, placa, cor..." />
      <div class="multiselect" id="multiselect-proposta-total"></div>
      <div class="multiselect" id="multiselect-patio-total"></div>
      <div class="multiselect" id="multiselect-modelo-total"></div>
      <div class="multiselect" id="multiselect-descricao-total"></div>
      <button onclick="resetFilters('total')">Limpar Filtros</button>
    </div>

    <div class="charts">
      <div class="chart-container"><canvas id="pie-modelos-total"></canvas></div>
      <div class="chart-container"><canvas id="bar-dias-total"></canvas></div>
    </div>
  </div>

  <script>
    let dadosDisponivel = [];
    let dadosRepasse = [];

    let filtroDisponivel = { search: '', proposta: [], patio: [], modelo: [], dias: '', descricao: [] };
    let filtroRepasse   = { search: '', proposta: [], patio: [], descricao: [] };
    let filtroTotal     = { search: '', proposta: [], patio: [], modelo: [], dias: '', descricao: [] };
    let sortDisponivel = { col: null, asc: true };
    let sortRepasse = { col: null, asc: true };

    const OPCOES_SITUACAO = ['DISPON√çVEL', 'INDISPON√çVEL'];
    const OPCOES_PROPOSTA = ['SIM', 'N√ÉO'];

    // Exportar Excel (mantido)
    function exportToExcel() {
      try {
        let tabAtual;
        if (document.getElementById('tab-disponivel').classList.contains('active')) tabAtual = 'disponivel';
        else if (document.getElementById('tab-repasse').classList.contains('active')) tabAtual = 'repasse';
        else tabAtual = 'total';

        let registros = [];
        let filtro;
        if (tabAtual === 'disponivel') { registros = dadosDisponivel.slice(); filtro = filtroDisponivel; }
        else if (tabAtual === 'repasse') { registros = dadosRepasse.slice(); filtro = filtroRepasse; }
        else { registros = dadosDisponivel.concat(dadosRepasse); filtro = filtroTotal; }

        if (filtro.search) {
          const s = filtro.search.toLowerCase();
          registros = registros.filter(item =>
            ((item.modelo || '').toLowerCase().includes(s)) ||
            ((item.placa || '').toLowerCase().includes(s)) ||
            ((item.cor || '').toLowerCase().includes(s))
          );
        }
        if (filtro.proposta?.length) { registros = registros.filter(item => filtro.proposta.includes(item.proposta)); }
        if (filtro.patio?.length) { registros = registros.filter(item => filtro.patio.includes(item.patio)); }
        if ((tabAtual === 'disponivel' || tabAtual === 'total') && filtro.modelo?.length) {
          registros = registros.filter(item => filtro.modelo.includes(normalizeModelo(item.modelo)));
        }
        if ((tabAtual === 'disponivel' || tabAtual === 'total') && filtro.dias) {
          const faixa = filtro.dias;
          registros = registros.filter(item => {
            if (faixa === '1-30') return item.dias >= 1 && item.dias <= 30;
            if (faixa === '31-60') return item.dias >= 31 && item.dias <= 60;
            if (faixa === '61-90') return item.dias >= 61 && item.dias <= 90;
            if (faixa === '91+') return item.dias >= 91;
            return true;
          });
        }
        if (filtro.descricao?.length) {
          const selecionadasNorm = filtro.descricao.map(normalizeDescricao);
          registros = registros.filter(item => selecionadasNorm.includes(normalizeDescricao(item.descricao)));
        }
        if (!registros?.length) { showStatus('‚ö†Ô∏è Nenhum registro filtrado para exportar.', true); return; }

        const dadosExport = registros.map(item => ({
          'Proposta': item.proposta || '',
          'P√°tio': item.patio || '',
          'Modelo': item.modelo || '',
          'Dias': item.dias || 0,
          'Ano': item.ano || '',
          'Cor Externa': item.cor || '',
          'Placa': item.placa || '',
          'KM': item.km || '',
          'Pre√ßo Venda': item.preco || 0,
          'Descri√ß√£o Situa√ß√£o': item.descricao || '',
          'Total Nota F√°brica': item.custo || 0,
          'Margem Bruta': (typeof item.margem !== 'undefined') ? item.margem : ((item.preco || 0) - (item.custo || 0)),
          '% Margem': (typeof item.margemPercent !== 'undefined') ? item.margemPercent : ((item.preco || 0) !== 0 ? (((item.preco || 0) - (item.custo || 0)) / (item.preco || 1)) * 100 : 0)
        }));

        const wb = XLSX.utils.book_new();
        const nomeAba = tabAtual === 'disponivel' ? 'Dispon√≠vel' : (tabAtual === 'repasse' ? 'Repasse' : 'Total');
        const ws = XLSX.utils.json_to_sheet(dadosExport);
        XLSX.utils.book_append_sheet(wb, ws, nomeAba);
        const agora = new Date();
        const dataStr = `${agora.getFullYear()}-${String(agora.getMonth()+1).padStart(2,'0')}-${String(agora.getDate()).padStart(2,'0')}`;
        const nomeArquivo = `${nomeAba.toLowerCase()}_export_${dataStr}.xlsx`;
        XLSX.writeFile(wb, nomeArquivo);
        showStatus('‚úÖ Exporta√ß√£o para Excel conclu√≠da com sucesso!');
      } catch (err) {
        console.error('Erro ao exportar Excel:', err);
        showStatus(`‚ùå Erro ao exportar Excel: ${err.message}`, true);
      }
    }

    // Utilidades
    function showStatus(message, isError = false) {
      const statusDiv = document.getElementById('status-info');
      statusDiv.style.display = 'block';
      statusDiv.className = `status-info ${isError ? 'status-error' : 'status-success'}`;
      statusDiv.innerHTML = message;
      if (!isError) setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
    }
    function formatMoney(valor) { return Number(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
    function normalizeModelo(modelo) { return (modelo||'').split(' ')[0].toUpperCase(); }
    function stripAccents(s) { return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g, ''); }
    function normalizeDescricao(s) { return stripAccents((s||'').toUpperCase()).trim(); }

    // >>> NOVO: helpers para cor principal
    const CORES_BASE = ['PRETO','BRANCO','CINZA','PRATA','AZUL','VERMELHO','VERDE','AMARELO','MARROM','BEGE','LARANJA','BORDO','VINHO','DOURADO','ROXO'];
    function primeiraPalavraAlpha(s) {
      const m = stripAccents(String(s||'').toUpperCase()).match(/[A-Z√Å-√ö]+/g);
      return m && m.length ? m[0] : '';
    }
    function normalizeCorPrincipal(corRaw) {
      const texto = stripAccents(String(corRaw||'').toUpperCase()).trim();
      if (!texto) return '';
      // prioridade: primeira palavra
      const p = primeiraPalavraAlpha(texto);
      if (CORES_BASE.includes(p)) return p;
      // fallback: se encontrar alguma cor-base em qualquer posi√ß√£o
      for (const base of CORES_BASE) { if (texto.includes(base)) return base; }
      return p || '';
    }
    function properCase(s) { return (s||'').toLowerCase().replace(/^\w|\s\w/g, c => c.toUpperCase()); }

    function showTab(idx) {
      document.querySelectorAll('.tab-btn').forEach((btn, i) => btn.classList.toggle('active', i === idx));
      document.querySelectorAll('.tab-content').forEach((tab, i) => tab.classList.toggle('active', i === idx));
      if(idx === 2) { preencherResumoTotal(); preencherGraficosTotal(); }
    }

    function calcularMediaKm(dados) {
      const kms = dados.map(x => Number((x.km+'').replace(/\D/g,''))).filter(x => !isNaN(x) && x > 0);
      if (!kms.length) return '0';
      return (kms.reduce((a,b)=>a+b,0)/kms.length).toLocaleString('pt-BR', {maximumFractionDigits:0});
    }
    function calcularMediaAno(dados) {
      const anos = dados.map(x => {
        if (!x.ano) return null;
        const partes = (x.ano + '').split('/');
        let ano = partes.length > 1 ? partes[1] : partes[0];
        if ((ano+'').length === 2) ano = '20' + ano;
        return Number(ano);
      }).filter(x => !isNaN(x) && x > 1900 && x < 2100);
      if (!anos.length) return '-';
      return (anos.reduce((a, b) => a + b, 0) / anos.length).toFixed(1);
    }

    // >>> NOVO: cor mais frequente (considerando filtros da aba Dispon√≠vel)
    function calcularCorMaisFrequente(dados) {
      const cont = {};
      dados.forEach(item => {
        const base = normalizeCorPrincipal(item.cor);
        if (!base) return;
        cont[base] = (cont[base] || 0) + 1;
      });
      const pares = Object.entries(cont);
      if (!pares.length) return { nome: '-', qtd: 0 };
      pares.sort((a,b)=>b[1]-a[1]);
      return { nome: properCase(pares[0][0]), qtd: pares[0][1] };
    }

    // TABELAS
    function preencherTabela(tab) {
      const tbody = document.querySelector(`#tabela-${tab} tbody`);
      let dados = (tab === 'disponivel' ? dadosDisponivel : dadosRepasse).slice();
      let filtro = (tab === 'disponivel' ? filtroDisponivel : filtroRepasse);

      // Texto livre
      if (filtro.search) {
        const s = filtro.search.toLowerCase();
        dados = dados.filter(item =>
          (item.modelo||'').toLowerCase().includes(s) ||
          (item.placa||'').toLowerCase().includes(s) ||
          (item.cor||'').toLowerCase().includes(s)
        );
      }
      // Proposta
      if (filtro.proposta.length) { dados = dados.filter(item => filtro.proposta.includes(item.proposta)); }
      // P√°tio
      if (filtro.patio.length) { dados = dados.filter(item => filtro.patio.includes(item.patio)); }
      // Modelo
      if (tab === 'disponivel' && filtro.modelo.length) {
        dados = dados.filter(item => filtro.modelo.includes(normalizeModelo(item.modelo)));
      }
      // Dias
      if (tab === 'disponivel' && filtro.dias) {
        const faixa = filtro.dias;
        dados = dados.filter(item => {
          if (faixa === '1-30') return item.dias >= 1 && item.dias <= 30;
          if (faixa === '31-60') return item.dias >= 31 && item.dias <= 60;
          if (faixa === '61-90') return item.dias >= 61 && item.dias <= 90;
          if (faixa === '91+') return item.dias >= 91;
        });
      }
      // Situa√ß√£o
      if (filtro.descricao.length) {
        const selecionadasNorm = filtro.descricao.map(normalizeDescricao);
        dados = dados.filter(item => selecionadasNorm.includes(normalizeDescricao(item.descricao)));
      }

      // Ordena√ß√£o
      let sort = (tab === 'disponivel' ? sortDisponivel : sortRepasse);
      if (sort.col) {
        dados.sort((a, b) => {
          let vA = a[sort.col], vB = b[sort.col];
          if (typeof vA === 'string') vA = vA.toLowerCase();
          if (typeof vB === 'string') vB = vB.toLowerCase();
          if (vA < vB) return sort.asc ? -1 : 1;
          if (vA > vB) return sort.asc ? 1 : -1;
          return 0;
        });
      }

      // Render + Totais
      tbody.innerHTML = '';
      let totalCusto = 0, totalPreco = 0, totalDias = 0;
      dados.forEach(item => {
        totalCusto += Number(item.custo);
        totalPreco += Number(item.preco);
        totalDias += Number(item.dias);

        const margemBrutaItem = Number(item.preco || 0) - Number(item.custo || 0);
        const margemPercentItem = Number(item.preco || 0) !== 0 ? ((margemBrutaItem / Number(item.preco)) * 100) : 0;
        const margemPercentFormatada = margemPercentItem.toFixed(2) + '%';

        // >>> NOVO: define classe da linha quando a margem √© negativa <<<
        const rowClass = (margemBrutaItem < 0) ? 'neg-row' : '';

        tbody.innerHTML += `
          <tr class="${rowClass}">
            <td>${item.proposta || ''}</td>
            <td>${item.patio || ''}</td>
            <td>${item.modelo || ''}</td>
            <td>${item.dias || ''}</td>
            <td>${item.ano || ''}</td>
            <td>${item.cor || ''}</td>
            <td>${item.placa || ''}</td>
            <td>${item.km || ''}</td>
            <td>${formatMoney(item.preco || 0)}</td>
            <td>${item.descricao || ''}</td>
            <td>${formatMoney(item.custo || 0)}</td>
            <td>${formatMoney(margemBrutaItem)}</td>
            <td>${margemPercentFormatada}</td>
          </tr>
        `;
      });

      // KPIs por aba + Margem M√©dia por Ve√≠culo
      if (tab === 'disponivel') {
        document.getElementById('qtd-disponivel').textContent = dados.length;
        document.getElementById('total-custo-disponivel').textContent = formatMoney(totalCusto);
        document.getElementById('total-preco-disponivel').textContent = formatMoney(totalPreco);
        document.getElementById('media-dias-disponivel').textContent = (totalDias / (dados.length || 1)).toFixed(2);
        const margemBrutaDisp = totalPreco - totalCusto;
        document.getElementById('margem-bruta-disponivel').textContent = formatMoney(margemBrutaDisp);
        const percentDisp = totalPreco > 0 ? ((margemBrutaDisp / totalPreco) * 100).toFixed(2) : '0.00';
        document.getElementById('margem-percent-disponivel').textContent = percentDisp + '%';
        const margemMediaDisp = dados.length ? (margemBrutaDisp / dados.length) : 0;
        document.getElementById('margem-media-disponivel').textContent = formatMoney(margemMediaDisp);

        document.getElementById('media-km-disponivel').textContent = calcularMediaKm(dados);
        document.getElementById('media-ano-disponivel').textContent = calcularMediaAno(dados);
        document.getElementById('media-custo-disponivel').textContent = dados.length ? formatMoney(totalCusto/dados.length) : 'R$ 0,00';
        document.getElementById('media-preco-venda-disponivel').textContent = dados.length ? formatMoney(totalPreco/dados.length) : 'R$ 0,00';

        // >>> NOVO: atualizar KPI da cor mais frequente
        const corTop = calcularCorMaisFrequente(dados);
        const elCor = document.getElementById('cor-frequente-disponivel');
        elCor.textContent = corTop.qtd ? `${corTop.nome} (${corTop.qtd})` : '-';
        elCor.title = corTop.qtd ? `Quantidade: ${corTop.qtd}` : '';

        preencherGraficos('pie-modelos', 'bar-dias', dados);
        atualizarBarraLojasDisponivel(dados);
      } else {
        document.getElementById('qtd-repasse').textContent = dados.length;
        document.getElementById('total-custo-repasse').textContent = formatMoney(totalCusto);
        document.getElementById('media-veiculo-repasse').textContent = formatMoney(totalCusto / (dados.length || 1));
        document.getElementById('media-dias-repasse').textContent = (totalDias / (dados.length || 1)).toFixed(1);
        document.getElementById('media-km-repasse').textContent = calcularMediaKm(dados);
        const margemBrutaRep = totalPreco - totalCusto;
        const margemMediaRep = dados.length ? (margemBrutaRep / dados.length) : 0;
        document.getElementById('margem-media-repasse').textContent = formatMoney(margemMediaRep);
      }
    }

    function preencherResumoTotal() {
      let dados = [...dadosDisponivel, ...dadosRepasse];

      if (filtroTotal.search) {
        const s = filtroTotal.search.toLowerCase();
        dados = dados.filter(item =>
          (item.modelo||'').toLowerCase().includes(s) ||
          (item.placa||'').toLowerCase().includes(s) ||
          (item.cor||'').toLowerCase().includes(s)
        );
      }
      if (filtroTotal.proposta.length) { dados = dados.filter(item => filtroTotal.proposta.includes(item.proposta)); }
      if (filtroTotal.patio.length) { dados = dados.filter(item => filtroTotal.patio.includes(item.patio)); }
      if (filtroTotal.modelo.length) { dados = dados.filter(item => filtroTotal.modelo.includes(normalizeModelo(item.modelo))); }
      if (filtroTotal.dias) {
        const faixa = filtroTotal.dias;
        dados = dados.filter(item => {
          if (faixa === '1-30') return item.dias >= 1 && item.dias <= 30;
          if (faixa === '31-60') return item.dias >= 31 && item.dias <= 60;
          if (faixa === '61-90') return item.dias >= 61 && item.dias <= 90;
          if (faixa === '91+') return item.dias >= 91;
        });
      }
      if (filtroTotal.descricao.length) {
        const selecionadasNorm = filtroTotal.descricao.map(normalizeDescricao);
        dados = dados.filter(item => selecionadasNorm.includes(normalizeDescricao(item.descricao)));
      }

      const totalQtd = dados.length;
      const totalCusto = dados.reduce((a,b)=>a+Number(b.custo),0);
      const totalPreco = dados.reduce((a,b)=>a+Number(b.preco),0);
      const totalDias = dados.reduce((a,b)=>a+Number(b.dias),0);

      document.getElementById('qtd-total').textContent = totalQtd;
      document.getElementById('total-custo-total').textContent = formatMoney(totalCusto);
      document.getElementById('total-preco-total').textContent = formatMoney(totalPreco);
      document.getElementById('media-dias-total').textContent = (totalDias / (totalQtd || 1)).toFixed(2);
      const margemBrutaTot = totalPreco - totalCusto;
      document.getElementById('margem-bruta-total').textContent = formatMoney(margemBrutaTot);
      const percentTot = totalPreco > 0 ? ((margemBrutaTot / totalPreco) * 100).toFixed(2) : '0.00';
      document.getElementById('margem-percent-total').textContent = percentTot + '%';
      document.getElementById('media-km-total').textContent = calcularMediaKm(dados);
      const margemMediaTot = totalQtd ? (margemBrutaTot / totalQtd) : 0;
      document.getElementById('margem-media-total').textContent = formatMoney(margemMediaTot);
    }

    function preencherGraficosTotal() {
      let dados = [...dadosDisponivel, ...dadosRepasse];

      if (filtroTotal.search) {
        const s = filtroTotal.search.toLowerCase();
        dados = dados.filter(item =>
          (item.modelo||'').toLowerCase().includes(s) ||
          (item.placa||'').toLowerCase().includes(s) ||
          (item.cor||'').toLowerCase().includes(s)
        );
      }
      if (filtroTotal.proposta.length) { dados = dados.filter(item => filtroTotal.proposta.includes(item.proposta)); }
      if (filtroTotal.patio.length) { dados = dados.filter(item => filtroTotal.patio.includes(item.patio)); }
      if (filtroTotal.modelo.length) { dados = dados.filter(item => filtroTotal.modelo.includes(normalizeModelo(item.modelo))); }
      if (filtroTotal.dias) {
        const faixa = filtroTotal.dias;
        dados = dados.filter(item => {
          if (faixa === '1-30') return item.dias >= 1 && item.dias <= 30;
          if (faixa === '31-60') return item.dias >= 31 && item.dias <= 60;
          if (faixa === '61-90') return item.dias >= 61 && item.dias <= 90;
          if (faixa === '91+') return item.dias >= 91;
        });
      }
      if (filtroTotal.descricao.length) {
        const selecionadasNorm = filtroTotal.descricao.map(normalizeDescricao);
        dados = dados.filter(item => selecionadasNorm.includes(normalizeDescricao(item.descricao)));
      }

      preencherGraficos('pie-modelos-total', 'bar-dias-total', dados, true);
    }

    function preencherGraficos(pieId, barId, dados, isTotal) {
      const modelos = {};
      dados.forEach(item => {
        const nome = normalizeModelo(item.modelo||'');
        modelos[nome] = (modelos[nome] || 0) + 1;
      });
      const topModelos = Object.entries(modelos).sort((a, b) => b[1] - a[1]).slice(0, 5);
      const pieModelosData = {
        labels: topModelos.map(x => x[0]),
        datasets: [{ data: topModelos.map(x => x[1]), backgroundColor: ['#7ed6b5','#5a8ac6','#f7b731','#eb3b5a','#8854d0'], borderColor: '#fff', borderWidth: 3 }]
      };
      if (window[pieId+'Chart']) window[pieId+'Chart'].destroy();
      window[pieId+'Chart'] = new Chart(document.getElementById(pieId), {
        type: 'pie',
        data: pieModelosData,
        options: {
          plugins: { legend: { position: 'top' }, tooltip: { enabled: true } },
          onClick: (evt, elements) => {
            if (elements.length) {
              const idx = elements[0].index;
              if (isTotal) {
                filtroTotal.modelo = [pieModelosData.labels[idx]];
                updateMultiSelect('multiselect-modelo-total', getModelosTotal(), filtroTotal.modelo, v => { filtroTotal.modelo = v; preencherResumoTotal(); preencherGraficosTotal(); }, 'Modelo');
                preencherResumoTotal(); preencherGraficosTotal();
              } else {
                filtroDisponivel.modelo = [pieModelosData.labels[idx]];
                updateMultiSelect('multiselect-modelo-disponivel', getModelosDisponivel(), filtroDisponivel.modelo, v => { filtroDisponivel.modelo = v; preencherTabela('disponivel'); }, 'Modelo');
                preencherTabela('disponivel');
              }
            }
          }
        }
      });

      const faixas = { '1-30': 0, '31-60': 0, '61-90': 0, '91+': 0 };
      dados.forEach(item => {
        if (item.dias >= 1 && item.dias <= 30) faixas['1-30']++;
        else if (item.dias >= 31 && item.dias <= 60) faixas['31-60']++;
        else if (item.dias >= 61 && item.dias <= 90) faixas['61-90']++;
        else if (item.dias >= 91) faixas['91+']++;
      });
      const barDiasData = { labels: Object.keys(faixas), datasets: [{ label: 'Qtd. de carros', data: Object.values(faixas), backgroundColor: ['#7ed6b5','#5a8ac6','#f7b731','#eb3b5a'] }] };
      if (window[barId+'Chart']) window[barId+'Chart'].destroy();
      window[barId+'Chart'] = new Chart(document.getElementById(barId), {
        type: 'bar',
        data: barDiasData,
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { enabled: true } },
          scales: { x: { title: { display: true, text: 'Dias em Estoque' } }, y: { title: { display: true, text: 'Quantidade de ve√≠culos' }, beginAtZero: true } },
          onClick: (evt, elements) => {
            if (elements.length) {
              const idx = elements[0].index;
              if (isTotal) { filtroTotal.dias = barDiasData.labels[idx]; preencherResumoTotal(); preencherGraficosTotal(); }
              else { filtroDisponivel.dias = barDiasData.labels[idx]; preencherTabela('disponivel'); }
            }
          }
        }
      });
    }

    function atualizarBarraLojasDisponivel(dados) {
      const contagem = {};
      dados.forEach(item => {
        let loja = (item.patio || '').trim();
        if (!loja) loja = 'Outros';
        contagem[loja] = (contagem[loja] || 0) + 1;
      });
      const lojasOrdenadas = Object.entries(contagem).sort((a, b) => b[1] - a[1]).map(x => x[0]);
      const quantidades = lojasOrdenadas.map(loja => contagem[loja]);
      if (window.barLojasDisponivelChart) window.barLojasDisponivelChart.destroy();
      window.barLojasDisponivelChart = new Chart(document.getElementById('bar-lojas'), {
        type: 'bar',
        data: { labels: lojasOrdenadas, datasets: [{ label: 'Estoque por Loja', data: quantidades, backgroundColor: ['#7ed6b5','#5a8ac6','#f7b731','#eb3b5a','#8854d0','#20bf6b','#fd9644','#a55eea','#778ca3','#e17055'] }] },
        options: {
          plugins: { legend: { display: false } }, indexAxis: 'x',
          scales: { x: { title: { display: false }, grid: { display: false } }, y: { title: { display: false }, beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } },
          responsive: true, maintainAspectRatio: false
        }
      });
    }

    // Helpers Multi-select
    function createMultiSelect(id, options, selected, onChange, label) {
      const container = document.getElementById(id);
      container.innerHTML = `
        <div class="selectBox">${label}: <span class="selected-items" style="margin-left:6px;color:#2980b9">${selected.length ? selected.join(', ') : 'Todos'}</span></div>
        <div class="checkboxes"></div>
      `;
      const selectBox = container.querySelector('.selectBox');
      const checkboxes = container.querySelector('.checkboxes');
      checkboxes.innerHTML = '';
      options.forEach(opt => {
        const checked = selected.includes(opt) ? 'checked' : '';
        checkboxes.innerHTML += `<label><input type="checkbox" value="${opt}" ${checked}> ${opt}</label>`;
      });
      selectBox.onclick = e => { container.classList.toggle('active'); e.stopPropagation(); };
      checkboxes.onclick = e => e.stopPropagation();
      document.body.addEventListener('click', () => container.classList.remove('active'));
      checkboxes.querySelectorAll('input[type=checkbox]').forEach(cb => {
        cb.onchange = () => {
          const checked = Array.from(checkboxes.querySelectorAll('input[type=checkbox]:checked')).map(x=>x.value);
          container.querySelector('.selected-items').textContent = checked.length ? checked.join(', ') : 'Todos';
          onChange(checked);
        };
      });
    }
    function updateMultiSelect(id, options, selected, onChange, label) {
      createMultiSelect(id, options, selected, onChange, label);
    }

    // Listas √∫nicas
    function getPatiosDisponivel() { return [...new Set(dadosDisponivel.map(x=>x.patio).filter(Boolean))].sort(); }
    function getModelosDisponivel() { return [...new Set(dadosDisponivel.map(x=>normalizeModelo(x.modelo)).filter(Boolean))].sort(); }
    function getPatiosRepasse() { return [...new Set(dadosRepasse.map(x=>x.patio).filter(Boolean))].sort(); }
    function getPatiosTotal() { return [...new Set([...dadosDisponivel, ...dadosRepasse].map(x=>x.patio).filter(Boolean))].sort(); }
    function getModelosTotal() { return [...new Set([...dadosDisponivel, ...dadosRepasse].map(x=>normalizeModelo(x.modelo)).filter(Boolean))].sort(); }

    // Identifica colunas por similaridade
    function findCol(obj, keys) {
      const norm = s => s ? s.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/gi,'').toLowerCase() : '';
      const objKeys = Object.keys(obj).map(k => norm(k));
      for (let key of keys) {
        let idx = objKeys.findIndex(k => k.includes(norm(key)));
        if (idx !== -1) return Object.keys(obj)[idx];
      }
      return null;
    }

    // Detecta automaticamente a linha do cabe√ßalho
    function findDataStartRow(sheet) {
      try {
        if (!sheet || !sheet['!ref']) return 0;
        const range = XLSX.utils.decode_range(sheet['!ref']);
        const headerKeywords = ['modelo','patio','p√°tio','placa','dias','ano','cor','preco','pre√ßo','km','custo','fabrica','f√°brica','situacao','situa√ß√£o','descricao','descri√ß√£o','venda','estoque','quilometragem','nota','proposta'];
        let bestRow = 0, bestScore = 0;
        const maxRowsToCheck = Math.min(15, range.e.r + 1);
        for (let row = 0; row < maxRowsToCheck; row++) {
          let score = 0, filledCells = 0, hasKeywords = false;
          for (let col = range.s.c; col <= range.e.c; col++) {
            const cell = sheet[XLSX.utils.encode_cell({ r: row, c: col })];
            if (cell && String(cell.v).trim() !== '') {
              filledCells++;
              const cellValue = String(cell.v).toLowerCase().trim();
              for (let keyword of headerKeywords) {
                if (cellValue.includes(keyword)) { score += 10; hasKeywords = true; break; }
              }
              if (isNaN(cell.v) && cellValue.length > 2) score += 2;
            }
          }
          score += filledCells;
          if (row < 3 && !hasKeywords && filledCells < 5) score -= 5;
          if (score > bestScore && filledCells >= 3) { bestScore = score; bestRow = row; }
        }
        return bestRow;
      } catch { return 0; }
    }

    function convertSheetToData(sheet) {
      try {
        if (!sheet || !sheet['!ref']) return { data: [], detectedRow: 1 };
        const headerRow = findDataStartRow(sheet);
        const allData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '', blankrows: false });
        if (allData.length <= headerRow) return { data: [], detectedRow: headerRow + 1 };
        const headers = allData[headerRow];
        const dataRows = allData.slice(headerRow + 1);
        const jsonData = dataRows.map(row => {
          const obj = {};
          headers.forEach((header, index) => {
            if (header && header.toString().trim()) obj[header.toString().trim()] = row[index] || '';
          });
          return obj;
        }).filter(row => Object.values(row).some(val => val && val.toString().trim() !== ''));
        return { data: jsonData, detectedRow: headerRow + 1 };
      } catch (error) {
        showStatus(`‚ùå Erro ao processar planilha: ${error.message}`, true);
        return { data: [], detectedRow: 1 };
      }
    }

    // Upload base
    document.getElementById('basefile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      document.getElementById('basefile-name').textContent = file.name;
      showStatus('üìä Processando arquivo Excel...');

      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, {type: 'array'});

          let sheetDisponivel, sheetRepasse;
          workbook.SheetNames.forEach(name => {
            const norm = name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            if (!sheetDisponivel && (norm.includes('dispon') || norm.includes('estoque'))) sheetDisponivel = workbook.Sheets[name];
            if (!sheetRepasse && norm.includes('repasse')) sheetRepasse = workbook.Sheets[name];
          });
          if (!sheetDisponivel) sheetDisponivel = workbook.Sheets[workbook.SheetNames[0]];
          if (!sheetRepasse && workbook.SheetNames.length > 1) sheetRepasse = workbook.Sheets[workbook.SheetNames[1]];
          if (!sheetRepasse) sheetRepasse = sheetDisponivel;

          function mapRow(row) {
            const colAKey = Object.keys(row)[0];
            const propostaRaw = colAKey ? row[colAKey] : '';
            const descricaoRaw = row[findCol(row, ['descricao situacao','descri√ß√£o situa√ß√£o','situacao','situa√ß√£o'])] || '';

            const precoVal = Number(row[findCol(row, ['preco venda','pre√ßo venda','preco','pre√ßo'])] || 0);
            const custoVal = Number(row[findCol(row, ['total nota fabrica','nota fabrica','custo','valor de custo'])] || 0);
            const margemVal = precoVal - custoVal;
            const margemPercentVal = precoVal !== 0 ? ((margemVal / precoVal) * 100) : 0;

            return {
              proposta: (propostaRaw !== undefined && String(propostaRaw).toString().trim() !== '') ? 'SIM' : 'N√ÉO',
              patio: row[findCol(row, ['patio','p√°tio'])] || '',
              modelo: row[findCol(row, ['modelo','nome do modelo'])] || '',
              dias: Number(row[findCol(row, ['dpt','dias','dias estoque','dias em estoque'])] || 0),
              ano: row[findCol(row, ['ano/m','ano','ano modelo'])] || '',
              cor: row[findCol(row, ['cor externa','cor'])] || '',
              preco: precoVal,
              placa: row[findCol(row, ['placa'])] || '',
              km: row[findCol(row, ['km','quilometragem'])] || '',
              descricao: descricaoRaw,
              custo: custoVal,
              margem: margemVal,
              margemPercent: margemPercentVal
            }
          }

          const disponivelResult = convertSheetToData(sheetDisponivel);
          const repasseResult = convertSheetToData(sheetRepasse);

          dadosDisponivel = disponivelResult.data.map(mapRow);
          dadosRepasse = repasseResult.data.map(mapRow);

          const totalRegistros = dadosDisponivel.length + dadosRepasse.length;
          if (totalRegistros > 0) {
            showStatus(`‚úÖ Dados carregados com sucesso!<br>
              ‚Ä¢ Planilha "Dispon√≠vel": ${dadosDisponivel.length} registros (linha ${disponivelResult.detectedRow})<br>
              ‚Ä¢ Planilha "Repasse": ${dadosRepasse.length} registros (linha ${repasseResult.detectedRow})<br>
              ‚Ä¢ Total: ${totalRegistros} registros processados
            `);
          } else {
            showStatus('‚ö†Ô∏è Nenhum dado foi encontrado nas planilhas. Verifique se o arquivo est√° correto.', true);
            return;
          }

          // MULTISELECTS
          updateMultiSelect('multiselect-proposta-disponivel', OPCOES_PROPOSTA, filtroDisponivel.proposta, v => { filtroDisponivel.proposta = v; preencherTabela('disponivel'); }, 'Proposta');
          updateMultiSelect('multiselect-proposta-repasse',   OPCOES_PROPOSTA, filtroRepasse.proposta,   v => { filtroRepasse.proposta   = v; preencherTabela('repasse');   }, 'Proposta');
          updateMultiSelect('multiselect-proposta-total',     OPCOES_PROPOSTA, filtroTotal.proposta,     v => { filtroTotal.proposta     = v; preencherResumoTotal(); preencherGraficosTotal(); }, 'Proposta');

          updateMultiSelect('multiselect-patio-disponivel', getPatiosDisponivel(), filtroDisponivel.patio, v => { filtroDisponivel.patio = v; preencherTabela('disponivel'); }, 'P√°tio');
          updateMultiSelect('multiselect-modelo-disponivel', getModelosDisponivel(), filtroDisponivel.modelo, v => { filtroDisponivel.modelo = v; preencherTabela('disponivel'); }, 'Modelo');
          updateMultiSelect('multiselect-patio-repasse', getPatiosRepasse(), filtroRepasse.patio, v => { filtroRepasse.patio = v; preencherTabela('repasse'); }, 'P√°tio');
          updateMultiSelect('multiselect-patio-total', getPatiosTotal(), filtroTotal.patio, v => { filtroTotal.patio = v; preencherResumoTotal(); preencherGraficosTotal(); }, 'P√°tio');
          updateMultiSelect('multiselect-modelo-total', getModelosTotal(), filtroTotal.modelo, v => { filtroTotal.modelo = v; preencherResumoTotal(); preencherGraficosTotal(); }, 'Modelo');

          updateMultiSelect('multiselect-descricao-disponivel', OPCOES_SITUACAO, filtroDisponivel.descricao, v => { filtroDisponivel.descricao = v; preencherTabela('disponivel'); }, 'Situa√ß√£o');
          updateMultiSelect('multiselect-descricao-repasse',   OPCOES_SITUACAO, filtroRepasse.descricao,   v => { filtroRepasse.descricao   = v; preencherTabela('repasse');   }, 'Situa√ß√£o');
          updateMultiSelect('multiselect-descricao-total',     OPCOES_SITUACAO, filtroTotal.descricao,     v => { filtroTotal.descricao     = v; preencherResumoTotal(); preencherGraficosTotal(); }, 'Situa√ß√£o');

          preencherTabela('disponivel');
          preencherTabela('repasse');
          preencherResumoTotal();
          preencherGraficosTotal();
        } catch (error) {
          console.error('Erro ao processar arquivo:', error);
          showStatus(`‚ùå Erro ao processar arquivo: ${error.message}`, true);
        }
      };
      reader.onerror = function() { showStatus('‚ùå Erro ao ler o arquivo. Verifique se √© um arquivo Excel v√°lido.', true); };
      reader.readAsArrayBuffer(file);
    });

    // Eventos e sort nas colunas
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('search-repasse').addEventListener('input', e => { filtroRepasse.search = e.target.value; preencherTabela('repasse'); });
      document.getElementById('search-disponivel').addEventListener('input', e => { filtroDisponivel.search = e.target.value; preencherTabela('disponivel'); });
      document.getElementById('search-total').addEventListener('input', e => { filtroTotal.search = e.target.value; preencherResumoTotal(); preencherGraficosTotal(); });

      document.querySelectorAll('#tabela-repasse th').forEach(th => {
        th.addEventListener('click', function() {
          const col = th.getAttribute('data-col'); if (!col) return;
          if (sortRepasse.col === col) sortRepasse.asc = !sortRepasse.asc; else { sortRepasse.col = col; sortRepasse.asc = true; }
          atualizarSetas('repasse', sortRepasse); preencherTabela('repasse');
        });
      });
      document.querySelectorAll('#tabela-disponivel th').forEach(th => {
        th.addEventListener('click', function() {
          const col = th.getAttribute('data-col'); if (!col) return;
          if (sortDisponivel.col === col) sortDisponivel.asc = !sortDisponivel.asc; else { sortDisponivel.col = col; sortDisponivel.asc = true; }
          atualizarSetas('disponivel', sortDisponivel); preencherTabela('disponivel');
        });
      });

      // Inicializa√ß√£o visual (antes de carregar a base)
      updateMultiSelect('multiselect-proposta-disponivel', OPCOES_PROPOSTA, [], v => { filtroDisponivel.proposta = v; preencherTabela('disponivel'); }, 'Proposta');
      updateMultiSelect('multiselect-proposta-repasse',   OPCOES_PROPOSTA, [], v => { filtroRepasse.proposta   = v; preencherTabela('repasse');   }, 'Proposta');
      updateMultiSelect('multiselect-proposta-total',     OPCOES_PROPOSTA, [], v => { filtroTotal.proposta     = v; preencherResumoTotal(); preencherGraficosTotal(); }, 'Proposta');

      updateMultiSelect('multiselect-patio-disponivel',   [], [], v => { filtroDisponivel.patio   = v; preencherTabela('disponivel'); }, 'P√°tio');
      updateMultiSelect('multiselect-modelo-disponivel',  [], [], v => { filtroDisponivel.modelo  = v; preencherTabela('disponivel'); }, 'Modelo');
      updateMultiSelect('multiselect-patio-repasse',      [], [], v => { filtroRepasse.patio      = v; preencherTabela('repasse');   }, 'P√°tio');
      updateMultiSelect('multiselect-patio-total',        [], [], v => { filtroTotal.patio        = v; preencherResumoTotal(); preencherGraficosTotal(); }, 'P√°tio');
      updateMultiSelect('multiselect-modelo-total',       [], [], v => { filtroTotal.modelo       = v; preencherResumoTotal(); preencherGraficosTotal(); }, 'Modelo');

      updateMultiSelect('multiselect-descricao-disponivel', OPCOES_SITUACAO, [], v => { filtroDisponivel.descricao = v; preencherTabela('disponivel'); }, 'Situa√ß√£o');
      updateMultiSelect('multiselect-descricao-repasse',   OPCOES_SITUACAO, [], v => { filtroRepasse.descricao   = v; preencherTabela('repasse');   }, 'Situa√ß√£o');
      updateMultiSelect('multiselect-descricao-total',     OPCOES_SITUACAO, [], v => { filtroTotal.descricao     = v; preencherResumoTotal(); preencherGraficosTotal(); }, 'Situa√ß√£o');
    });

    function atualizarSetas(tab, sort) {
      const ths = document.querySelectorAll(`#tabela-${tab} th`);
      ths.forEach(th => {
        const col = th.getAttribute('data-col');
        const arrow = th.querySelector('.sort-arrow');
        if (col === sort.col) arrow.textContent = sort.asc ? '‚ñ≤' : '‚ñº';
        else arrow.textContent = '';
      });
    }

    function resetFilters(tab) {
      if (tab === 'repasse') {
        filtroRepasse = { search: '', proposta: [], patio: [], descricao: [] };
        document.getElementById('search-repasse').value = '';
        updateMultiSelect('multiselect-proposta-repasse', OPCOES_PROPOSTA, [], v => { filtroRepasse.proposta = v; preencherTabela('repasse'); }, 'Proposta');
        updateMultiSelect('multiselect-patio-repasse', getPatiosRepasse(), [], v => { filtroRepasse.patio = v; preencherTabela('repasse'); }, 'P√°tio');
        updateMultiSelect('multiselect-descricao-repasse', OPCOES_SITUACAO, [], v => { filtroRepasse.descricao = v; preencherTabela('repasse'); }, 'Situa√ß√£o');
        preencherTabela('repasse');
      } else if (tab === 'disponivel') {
        filtroDisponivel = { search: '', proposta: [], patio: [], modelo: [], dias: '', descricao: [] };
        document.getElementById('search-disponivel').value = '';
        updateMultiSelect('multiselect-proposta-disponivel', OPCOES_PROPOSTA, [], v => { filtroDisponivel.proposta = v; preencherTabela('disponivel'); }, 'Proposta');
        updateMultiSelect('multiselect-patio-disponivel', getPatiosDisponivel(), [], v => { filtroDisponivel.patio = v; preencherTabela('disponivel'); }, 'P√°tio');
        updateMultiSelect('multiselect-modelo-disponivel', getModelosDisponivel(), [], v => { filtroDisponivel.modelo = v; preencherTabela('disponivel'); }, 'Modelo');
        updateMultiSelect('multiselect-descricao-disponivel', OPCOES_SITUACAO, [], v => { filtroDisponivel.descricao = v; preencherTabela('disponivel'); }, 'Situa√ß√£o');
        preencherTabela('disponivel');
      } else if (tab === 'total') {
        filtroTotal = { search: '', proposta: [], patio: [], modelo: [], dias: '', descricao: [] };
        document.getElementById('search-total').value = '';
        updateMultiSelect('multiselect-proposta-total', OPCOES_PROPOSTA, [], v => { filtroTotal.proposta = v; preencherResumoTotal(); preencherGraficosTotal(); }, 'Proposta');
        updateMultiSelect('multiselect-patio-total', getPatiosTotal(), [], v => { filtroTotal.patio = v; preencherResumoTotal(); preencherGraficosTotal(); }, 'P√°tio');
        updateMultiSelect('multiselect-modelo-total', getModelosTotal(), [], v => { filtroTotal.modelo = v; preencherResumoTotal(); preencherGraficosTotal(); }, 'Modelo');
        updateMultiSelect('multiselect-descricao-total', OPCOES_SITUACAO, [], v => { filtroTotal.descricao = v; preencherResumoTotal(); preencherGraficosTotal(); }, 'Situa√ß√£o');
        preencherResumoTotal(); preencherGraficosTotal();
      }
    }
  </script>
</body>
</html>